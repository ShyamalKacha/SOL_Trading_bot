<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Solana Trading Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- Solana Web3 Library -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body class="bg-dark text-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">Solana Trading Bot</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/wallet">Wallet</a>
                <a class="nav-link" href="/trading">Trading</a>
                <a class="nav-link" href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>Trading Dashboard</h1>
                <p class="text-muted">Welcome to your personalized trading dashboard</p>
            </div>
        </div>

        <!-- Wallet Information Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light text-dark">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Your Wallet</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshWalletData()" title="Refresh Balances">
                            â†» Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Wallet Address -->
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label class="form-label">Wallet Address</label>
                                <div class="input-group">
                                    <div class="wallet-address flex-grow-1" id="walletAddress">
                                        Loading...
                                    </div>
                                    <button class="btn btn-outline-secondary copy-btn" type="button"
                                        onclick="copyWalletAddress()" title="Copy Address">
                                        Copy
                                    </button>
                                </div>
                                <div id="walletError" class="text-danger small mt-1" style="display: none;"></div>
                            </div>
                            <!-- Token Balances -->
                            <div class="col-md-6">
                                <label class="form-label">Token Balances</label>
                                <div id="tokenBalancesContainer" class="border rounded p-2 bg-light">
                                    <div id="tokenBalancesLoading" class="text-center py-2 text-muted">
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                        Loading balances...
                                    </div>
                                    <div id="tokenBalances" style="display: none;">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Token</th>
                                                    <th class="text-end">Balance</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tokenBalancesList">
                                            </tbody>
                                        </table>
                                    </div>
                                    <div id="noTokens" class="text-center py-2 text-muted" style="display: none;">
                                        No tokens found in wallet
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Management Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light text-dark">
                    <div class="card-header">
                        <h5>Wallet Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Add Funds</h6>
                                <div class="mb-3">
                                    <label for="addAmount" class="form-label">Amount to Add</label>
                                    <input type="number" class="form-control" id="addAmount" placeholder="Enter amount" min="0" step="0.01">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Your Deposit Address</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="depositAddress" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyDepositAddress()" title="Copy Address">
                                            Copy
                                        </button>
                                    </div>
                                </div>
                                <button class="btn btn-success" onclick="connectWalletAndDeposit()">Connect Wallet & Deposit</button>
                            </div>
                            <div class="col-md-6">
                                <h6>Withdraw Funds</h6>
                                <div class="mb-3">
                                    <label for="withdrawAddress" class="form-label">Destination Address</label>
                                    <input type="text" class="form-control" id="withdrawAddress" placeholder="Enter wallet address">
                                </div>
                                <div class="mb-3">
                                    <label for="withdrawAmount" class="form-label">Amount to Withdraw</label>
                                    <input type="number" class="form-control" id="withdrawAmount" placeholder="Enter amount" min="0" step="0.01">
                                </div>
                                <button class="btn btn-danger" onclick="withdrawFunds()">Withdraw Funds</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Configuration -->
        <div class="row">
            <!-- Trading Configuration -->
            <div class="col-lg-4">
                <div class="card mb-4 bg-light text-dark">
                    <div class="card-header">
                        <h5>Trading Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="networkSelect" class="form-label">Network</label>
                            <select class="form-select" id="networkSelect">
                                <option value="mainnet">Mainnet</option>
                                <option value="devnet">Devnet</option>
                                <option value="testnet">Testnet</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tradingModeSelect" class="form-label">Trading Mode</label>
                            <select class="form-select" id="tradingModeSelect">
                                <option value="automatic">Automatic</option>
                                <option value="user">User Approval</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="selectedToken" class="form-label">Select Token (or enter custom below)</label>
                            <select class="form-select" id="selectedToken">
                                <option value="So11111111111111111111111111111111111111112">SOL - Solana</option>
                                <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC - USD Coin</option>
                                <option value="4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R">RAY - Raydium</option>
                                <option value="JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN">JUP - Jupiter</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="customTokenAddress" class="form-label">Or Enter Custom Token Address</label>
                            <input type="text" class="form-control" id="customTokenAddress"
                                placeholder="Enter token mint address">
                            <div class="form-text">Leave empty to use selected token above</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Parameters -->
            <div class="col-lg-4">
                <div class="card mb-4 bg-light text-dark">
                    <div class="card-header">
                        <h5>Trading Parameters</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Base Price ($)</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">$<span id="autoBasePrice">--</span></div>
                            <div class="form-text">Automatically set to current market price when trading starts</div>
                        </div>

                        <div class="mb-3">
                            <label for="upPercentage" class="form-label">Sell High Percentage (%)</label>
                            <input type="number" class="form-control" id="upPercentage" placeholder="Enter up percentage" value="5" min="0" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="downPercentage" class="form-label">Buy Low Percentage (%)</label>
                            <div class="form-text">Enter down percentage</div>
                            <input type="number" class="form-control" id="downPercentage" placeholder="Enter down percentage" value="3" min="0" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="tradeAmount" class="form-label">Trade Amount</label>
                            <input type="number" class="form-control" id="tradeAmount" placeholder="Enter trade amount" value="10" min="0" step="0.01">
                        </div>

                        <div class="mb-3">
                            <label for="partsInput" class="form-label">Number of Parts</label>
                            <input type="number" class="form-control" id="partsInput" placeholder="Enter number of parts" value="1" min="1" step="1">
                            <div class="form-text">Total trade amount will be divided into this many parts</div>
                        </div>

                        <div class="d-grid gap-2">
                            <button id="startTradingBtn" class="btn btn-success">Start Trading</button>
                            <button id="stopTradingBtn" class="btn btn-danger">Stop Trading</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Status and Current Price -->
            <div class="col-lg-4">
                <div class="card mb-4 bg-light text-dark">
                    <div class="card-header">
                        <h5>Trading Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div>
                                <span class="status-indicator status-inactive" id="statusIndicator"></span>
                                <span id="statusText">Stopped</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Current Price ($)</label>
                            <div class="alert alert-info" id="currentPrice">$0.00</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dynamic Base Price ($)</label>
                            <div class="alert alert-warning" id="dynamicBasePrice">$0.00</div>
                            <div class="form-text">Updated after each buy/sell operation</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Total Profit ($)</label>
                            <div class="alert alert-success" id="totalProfit">$0.00</div>
                            <div class="form-text">Cumulative profit/loss from all trades</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Last Action</label>
                            <div class="alert alert-light" id="lastAction">None</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Last Updated</label>
                            <div class="alert alert-light" id="lastUpdated">Never</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="row">
            <div class="col-12">
                <div class="card bg-light text-dark">
                    <div class="card-header">
                        <h5>Transaction History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Action</th>
                                        <th>Part</th>
                                        <th>Token</th>
                                        <th>Price ($)</th>
                                        <th>Base Price ($)</th>
                                        <th>P&L ($)</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionHistory">
                                    <tr>
                                        <td colspan="8" class="text-center">No transactions yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
        const startTradingBtn = document.getElementById('startTradingBtn');
        const stopTradingBtn = document.getElementById('stopTradingBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const currentPrice = document.getElementById('currentPrice');
        const dynamicBasePrice = document.getElementById('dynamicBasePrice');
        const totalProfit = document.getElementById('totalProfit');
        const lastAction = document.getElementById('lastAction');
        const lastUpdated = document.getElementById('lastUpdated');
        const transactionHistory = document.getElementById('transactionHistory');
        const partsInput = document.getElementById('partsInput');
        let tradingInterval = null;
        let fullWalletAddress = '';

        // Start trading button event
        startTradingBtn.addEventListener('click', async function() {
            // Determine which token address to use
            let selectedToken = document.getElementById('selectedToken').value;
            const customTokenAddress = document.getElementById('customTokenAddress').value.trim();

            if (customTokenAddress) {
                // Validate that it looks like a Solana address (32-44 characters)
                if (customTokenAddress.length >= 32 && customTokenAddress.length <= 44) {
                    selectedToken = customTokenAddress;
                } else {
                    alert('Please enter a valid Solana token address (32-44 characters)');
                    return;
                }
            }

            const config = {
                upPercentage: parseFloat(document.getElementById('upPercentage').value),
                downPercentage: parseFloat(document.getElementById('downPercentage').value),
                selectedToken: selectedToken,
                tradeAmount: parseFloat(document.getElementById('tradeAmount').value),
                parts: parseInt(document.getElementById('partsInput').value),
                network: document.getElementById('networkSelect').value,
                tradingMode: document.getElementById('tradingModeSelect').value
            };

            // Validate inputs
            if (isNaN(config.upPercentage) || isNaN(config.downPercentage) || isNaN(config.tradeAmount) || isNaN(config.parts)) {
                alert('Please enter valid numbers for all fields');
                return;
            }

            if (!config.selectedToken) {
                alert('Please select a token or enter a custom token address');
                return;
            }

            if (config.parts <= 0) {
                alert('Number of parts must be greater than 0');
                return;
            }

            try {
                const response = await fetch('/api/start-trading', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                console.log('Trading started:', data);

                // Update the automatic base price display to show the current market price
                // Get current price from the status API to show as the base price
                setTimeout(async () => {
                    const statusResponse = await fetch('/api/trading-status');
                    const statusData = await statusResponse.json();
                    if (statusData.current_price) {
                        document.getElementById('autoBasePrice').textContent = statusData.current_price.toFixed(8);
                    }
                }, 1000);  // Slight delay to allow base price to be set

                updateStatus(true);

                // Start polling for status updates
                if (tradingInterval) clearInterval(tradingInterval);
                tradingInterval = setInterval(updateTradingStatus, 2000);
            } catch (error) {
                console.error('Error starting trading:', error);
                alert('Error starting trading');
            }
        });

        // Stop trading button event
        stopTradingBtn.addEventListener('click', async function() {
            try {
                const response = await fetch('/api/stop-trading', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('Trading stopped:', data);
                updateStatus(false);

                if (tradingInterval) {
                    clearInterval(tradingInterval);
                    tradingInterval = null;
                }
            } catch (error) {
                console.error('Error stopping trading:', error);
                alert('Error stopping trading');
            }
        });

        // Function to update trading status
        async function updateTradingStatus() {
            try {
                const response = await fetch('/api/trading-status');
                const data = await response.json();

                // Update current price
                if (data.current_price) {
                    // Display with full precision for tokens with very low values
                    const priceValue = data.current_price;
                    let displayPrice;
                    if (priceValue >= 0.01) {
                        displayPrice = priceValue.toFixed(8);  // 8 decimal places for precision
                    } else {
                        displayPrice = priceValue.toFixed(8);  // 8 decimal places for low-value tokens
                    }
                    // Remove trailing zeros but keep precision
                    displayPrice = parseFloat(displayPrice).toString();
                    currentPrice.textContent = '$' + displayPrice;
                    lastUpdated.textContent = new Date().toLocaleTimeString();
                }

                // Update dynamic base price
                if (data.dynamic_base_price !== undefined) {
                    const dynamicBasePriceValue = data.dynamic_base_price;
                    let displayDynamicPrice;
                    if (dynamicBasePriceValue >= 0.01) {
                        displayDynamicPrice = dynamicBasePriceValue.toFixed(8);  // 8 decimal places for precision
                    } else {
                        displayDynamicPrice = dynamicBasePriceValue.toFixed(8);  // 8 decimal places for low-value tokens
                    }
                    // Remove trailing zeros but keep precision
                    displayDynamicPrice = parseFloat(displayDynamicPrice).toString();
                    dynamicBasePrice.textContent = '$' + displayDynamicPrice;
                }

                // Update total profit
                if (data.total_profit !== undefined) {
                    const profitValue = data.total_profit;
                    let displayProfit;
                    if (Math.abs(profitValue) >= 0.01) {
                        displayProfit = profitValue.toFixed(8);  // 8 decimal places for precision
                    } else {
                        displayProfit = profitValue.toFixed(8);  // 8 decimal places for low-value profits
                    }
                    // Remove trailing zeros but keep precision
                    displayProfit = parseFloat(displayProfit).toString();
                    // Add color coding based on profit/loss
                    if (profitValue > 0) {
                        totalProfit.textContent = '+$' + displayProfit;
                        totalProfit.className = 'alert alert-success';  // Green for profit
                    } else if (profitValue < 0) {
                        totalProfit.textContent = '-$' + Math.abs(parseFloat(displayProfit)).toString();
                        totalProfit.className = 'alert alert-danger';  // Red for loss
                    } else {
                        totalProfit.textContent = '$' + displayProfit;
                        totalProfit.className = 'alert alert-secondary';  // Gray for neutral
                    }
                }

                // Update last action
                if (data.last_action) {
                    lastAction.textContent = data.last_action.charAt(0).toUpperCase() + data.last_action.slice(1);
                }

                // Update transaction history
                if (data.transaction_history) {
                    updateTransactionHistory(data.transaction_history);
                }
            } catch (error) {
                console.error('Error fetching trading status:', error);
            }
        }

        // Function to update UI status indicators
        function updateStatus(isRunning) {
            if (isRunning) {
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = 'Running';
            } else {
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'Stopped';
            }
        }

        // Function to display token balances
        function displayTokenBalances(balances) {
            // Show/hide loading indicator
            document.getElementById('tokenBalancesLoading').style.display = 'none';
            document.getElementById('tokenBalances').style.display = 'block';

            const tokenBalancesList = document.getElementById('tokenBalancesList');
            const noTokens = document.getElementById('noTokens');

            if (balances.length === 0) {
                noTokens.style.display = 'block';
                tokenBalancesList.innerHTML = '';
                return;
            }

            noTokens.style.display = 'none';
            tokenBalancesList.innerHTML = '';

            balances.forEach(balance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>${balance.token}</div>
                        <small class="text-muted">${balance.name || ''}</small>
                    </td>
                    <td class="text-end">${balance.balance ? balance.balance.toFixed(6) : '0.000000'}</td>
                `;
                tokenBalancesList.appendChild(row);
            });
        }

        // Function to fetch wallet info
        async function fetchWalletInfo() {
            try {
                const response = await fetch('/api/wallet-info');
                const data = await response.json();

                if (data.success) {
                    fullWalletAddress = data.wallet_address;
                    document.getElementById('walletAddress').textContent = data.wallet_address;
                    document.getElementById('walletError').style.display = 'none';
                } else {
                    document.getElementById('walletAddress').textContent = 'Error loading wallet';
                    document.getElementById('walletError').textContent = data.message;
                    document.getElementById('walletError').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching wallet info:', error);
                document.getElementById('walletAddress').textContent = 'Error loading wallet';
                document.getElementById('walletError').textContent = 'Failed to connect to wallet API';
                document.getElementById('walletError').style.display = 'block';
            }
        }

        // Function to fetch token balances
        async function fetchTokenBalances() {
            try {
                // Show loading state
                document.getElementById('tokenBalancesLoading').style.display = 'block';
                document.getElementById('tokenBalances').style.display = 'none';
                document.getElementById('noTokens').style.display = 'none';

                const response = await fetch('/api/wallet-balance');
                const data = await response.json();

                if (data.success) {
                    displayTokenBalances(data.balances);
                } else {
                    console.error('Error from backend:', data.message);
                    document.getElementById('tokenBalancesLoading').style.display = 'none';
                    document.getElementById('walletError').textContent = data.message || 'Error loading balances';
                    document.getElementById('walletError').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching token balances:', error);
                document.getElementById('tokenBalancesLoading').style.display = 'none';
                document.getElementById('tokenBalances').innerHTML = '<div class="alert alert-danger">Error loading balances</div>';
            }
        }

        // Function to refresh wallet data
        async function refreshWalletData() {
            await fetchWalletInfo();
            await fetchTokenBalances();
        }

        // Function to copy wallet address to clipboard
        function copyWalletAddress() {
            if (fullWalletAddress) {
                navigator.clipboard.writeText(fullWalletAddress).then(() => {
                    // Show temporary feedback
                    const copyBtn = document.querySelector('.copy-btn');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy wallet address to clipboard');
                });
            }
        }

        // Function to add funds to wallet
        async function addFunds() {
            const amount = document.getElementById('addAmount').value;
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            try {
                const response = await fetch('/api/add-funds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: parseFloat(amount) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Funds added successfully!');
                    refreshWalletData();
                } else {
                    alert('Error adding funds: ' + data.message);
                }
            } catch (error) {
                console.error('Error adding funds:', error);
                alert('Error adding funds');
            }
        }

        // Function to withdraw funds from wallet
        async function withdrawFunds() {
            const address = document.getElementById('withdrawAddress').value;
            const amount = document.getElementById('withdrawAmount').value;
            
            if (!address) {
                alert('Please enter a destination address');
                return;
            }
            
            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            try {
                const response = await fetch('/api/withdraw-funds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        destination_address: address,
                        amount: parseFloat(amount) 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Funds withdrawn successfully!');
                    refreshWalletData();
                } else {
                    alert('Error withdrawing funds: ' + data.message);
                }
            } catch (error) {
                console.error('Error withdrawing funds:', error);
                alert('Error withdrawing funds');
            }
        }

        // Function to update transaction history table
        function updateTransactionHistory(transactions) {
            if (transactions.length === 0) {
                transactionHistory.innerHTML = '<tr><td colspan="8" class="text-center">No transactions yet</td></tr>';
                return;
            }

            let html = '';
            transactions.slice().reverse().forEach(tx => {
                // Use token symbol if available, otherwise use first 6 chars of token mint
                const displayToken = tx.token_symbol || tx.token.substring(0, 6) + '...';
                // Display price with full precision
                const displayPrice = parseFloat(tx.price.toFixed(8)).toString();
                const displayBasePrice = tx.base_price_at_execution ? parseFloat(tx.base_price_at_execution.toFixed(8)).toString() : 'N/A';
                // Calculate P&L if base price is available
                let displayPL = 'N/A';
                let plClass = '';
                if (tx.base_price_at_execution && tx.action === 'sell') {
                    const profitLoss = tx.price - tx.base_price_at_execution;
                    const formattedPL = parseFloat(profitLoss.toFixed(8)).toString();
                    if (profitLoss >= 0) {
                        displayPL = '+' + formattedPL;
                        plClass = 'text-success';  // Positive P&L in green
                    } else {
                        displayPL = formattedPL;
                        plClass = 'text-danger';  // Negative P&L in red
                    }
                } else if (tx.action === 'buy') {
                    displayPL = 'N/A';  // No P&L for buy transactions
                }

                // Part information - only show for sell operations
                let displayPart = tx.action === 'buy' ? '-' : 'N/A';
                if (tx.part_number !== undefined && tx.part_number !== null) {
                    if (tx.total_parts && tx.total_parts > 1) {
                        displayPart = `${tx.part_number}/${tx.total_parts}`;
                    } else {
                        displayPart = tx.part_number;  // Just show the part number if total is not informative
                    }
                } else if (tx.action === 'buy') {
                    displayPart = '-';  // Show dash for buy operations since they don't consume parts
                }

                // Transaction status badge
                const statusBadge = tx.status === 'completed' ? 'success' : 'danger';
                const statusText = tx.status === 'completed' ? 'Completed' : 'Failed';

                html += `<tr>
                    <td>${tx.timestamp}</td>
                    <td><span class="badge bg-${tx.action === 'buy' ? 'success' : 'danger'}">${tx.action}</span></td>
                    <td>${displayPart}</td>  <!-- Part number -->
                    <td>${displayToken}</td>
                    <td>$${displayPrice}</td>  <!-- Current price at execution -->
                    <td>$${displayBasePrice}</td>  <!-- Base price at execution -->
                    <td class="${plClass}">$${displayPL}</td>  <!-- Profit/Loss -->
                    <td>${tx.amount}</td>
                    <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                </tr>`;
            });

            transactionHistory.innerHTML = html;
        }

        // Initialize the page
        async function init() {
            updateStatus(false);
            // Fetch wallet info and balances on page load
            await fetchWalletInfo();
            await fetchTokenBalances();
            await displayDepositAddress(); // Display the deposit address

            // Refresh balances every 30 seconds
            setInterval(fetchTokenBalances, 30000);
        }

        // Call init when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Redirect to login page
                    window.location.href = '/login';
                } else {
                    console.error('Logout failed:', result.message);
                    // Still redirect to login even if server-side logout failed
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error during logout:', error);
                // Redirect to login even if there's an error
                window.location.href = '/login';
            }
        }

        // Function to display user's deposit address
        async function displayDepositAddress() {
            try {
                const response = await fetch('/api/deposit-address');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('depositAddress').value = data.deposit_address;
                    fullWalletAddress = data.deposit_address; // Update the global variable
                }
            } catch (error) {
                console.error('Error fetching deposit address:', error);
            }
        }

        // Function to copy deposit address to clipboard
        function copyDepositAddress() {
            const depositAddressInput = document.getElementById('depositAddress');
            if (depositAddressInput.value) {
                navigator.clipboard.writeText(depositAddressInput.value).then(() => {
                    // Show temporary feedback
                    const copyBtn = document.querySelector('[onclick="copyDepositAddress()"]');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy deposit address to clipboard');
                });
            }
        }

        // Function to connect wallet and initiate deposit
        async function connectWalletAndDeposit() {
            const amount = document.getElementById('addAmount').value;

            if (!amount || parseFloat(amount) <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            // Get the user's deposit address
            const depositAddress = document.getElementById('depositAddress').value;
            if (!depositAddress) {
                alert('Deposit address not loaded. Please refresh the page.');
                return;
            }

            // Check if Phantom wallet is available
            if (window.solana && window.solana.isPhantom) {
                try {
                    // Connect to Phantom wallet
                    const response = await window.solana.connect();
                    const userPublicKey = response.publicKey.toString();

                    // Create deposit transaction on the backend
                    const transactionResponse = await fetch('/api/create-deposit-transaction', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: parseFloat(amount)
                        })
                    });

                    const transactionData = await transactionResponse.json();

                    if (transactionData.success) {
                        // Create and send actual transaction
                        try {
                            // Create connection to Solana cluster
                            const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');

                            // Get the latest blockhash
                            const { blockhash } = await connection.getLatestBlockhash();

                            // Create transaction
                            const transaction = new solanaWeb3.Transaction({
                                feePayer: userPublicKey,
                                blockhash: blockhash,
                            });

                            // Add transfer instruction
                            const transferInstruction = solanaWeb3.SystemProgram.transfer({
                                fromPubkey: new solanaWeb3.PublicKey(userPublicKey),
                                toPubkey: new solanaWeb3.PublicKey(transactionData.transaction.destination),
                                lamports: parseFloat(amount) * solanaWeb3.LAMPORTS_PER_SOL, // Convert SOL to lamports
                            });

                            transaction.add(transferInstruction);

                            // Send transaction to user's wallet for confirmation
                            const signature = await window.solana.signAndSendTransaction(transaction);

                            // Show success message
                            alert(`Transaction sent successfully! Signature: ${signature.signature}`);

                            // Refresh balances
                            await fetchTokenBalances();
                        } catch (transactionError) {
                            console.error('Transaction error:', transactionError);
                            if (transactionError.message.includes('User rejected')) {
                                alert('Transaction was cancelled by the user.');
                            } else {
                                alert('Failed to send transaction: ' + transactionError.message);
                            }
                        }
                    } else {
                        console.error('Error creating transaction:', transactionData.message);
                        alert('Error creating deposit transaction: ' + transactionData.message);
                    }
                } catch (error) {
                    console.error('Phantom wallet error:', error);
                    if (error.message.includes('User rejected')) {
                        alert('Transaction was cancelled by the user.');
                    } else {
                        alert('Failed to process transaction. Please try again.\nError: ' + error.message);
                    }
                }
            } else {
                // Fallback: show deposit address and instructions
                alert(
                    `Phantom wallet not detected. To deposit funds:\n\n` +
                    `1. Open your Solana wallet (Phantom, Trust, etc.)\n` +
                    `2. Send ${amount} SOL to the following address:\n${depositAddress}\n\n` +
                    `The balance will update automatically when the transaction is confirmed on the blockchain.`
                );
            }
        }
    </script>
</body>
</html>