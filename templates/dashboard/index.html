{% extends "base.html" %}

{% block title %}Dashboard | AutoSOL{% endblock %}

{% block content %}
<div class="container-xl pb-5">
    <!-- Header Section -->
    <div class="row align-items-end mb-4">
        <div class="col-md-8">
            <h6 class="text-primary tracking-wide text-uppercase mb-2">System Status: Online</h6>
            <h1 class="display-5 fw-bold mb-0">TRADING <span class="text-primary-gradient">COMMAND CENTER</span></h1>
            <p class="text-muted mt-2 mb-0">Real-time and automated trade execution engine.</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="d-inline-flex align-items-center gap-2 px-3 py-2 rounded-pill"
                style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);">
                <span class="status-dot online"></span>
                <span class="font-mono text-light" id="clock">00:00:00</span>
            </div>
        </div>
    </div>

    <!-- Wallet Command Center -->
    <div class="glass-panel">
        <div class="glass-header">
            <div class="d-flex align-items-center gap-2">
                <i class="fa-solid fa-wallet text-primary"></i>
                <h5 class="font-mono tracking-tight">WALLET OPERATIONS</h5>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshWalletData()" title="Sync Chain Data">
                <i class="fas fa-sync-alt me-1"></i> SYNC
            </button>
        </div>
        <div class="glass-body">
            <div class="row g-4">
                <!-- Wallet ID & Identity -->
                <div class="col-lg-5">
                    <label class="form-label">Wallet Address</label>
                    <div class="input-group mb-3">
                        <div class="wallet-address flex-grow-1 font-mono text-primary" id="walletAddress">
                            <i class="fas fa-circle-notch fa-spin me-2"></i> Connecting to Solana...
                        </div>
                        <button class="btn btn-outline-secondary copy-btn" type="button" onclick="copyWalletAddress()"
                            title="Copy Address">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div id="walletError" class="alert alert-danger py-2 mt-2" style="display: none;"></div>
                </div>

                <!-- Portfolio Overview -->
                <div class="col-lg-7">
                    <label class="form-label">Asset Allocation</label>
                    <div id="tokenBalancesContainer" class="rounded p-0" style="min-height: 100px;">
                        <div id="tokenBalancesLoading" class="text-center py-4 text-muted">
                            <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
                            <div class="font-mono small">SCANNING ASSETS...</div>
                        </div>

                        <div id="tokenBalances" style="display: none;">
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table mb-0">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th class="text-end">Holding</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tokenBalancesList" class="font-mono">
                                        <!-- Populated via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="noTokens" class="text-center py-4 text-muted" style="display: none;">
                            <i class="fas fa-wallet fa-2x mb-2 opacity-50"></i>
                            <div>No assets detected</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Funding Operations (Collapsible) -->
    <div class="glass-panel">
        <div class="glass-header">
            <div class="d-flex align-items-center gap-2">
                <i class="fa-solid fa-money-bill-transfer text-success"></i>
                <h5 class="font-mono tracking-tight">FUNDING OPERATIONS</h5>
            </div>
        </div>
        <div>
            <div class="glass-body border-top border-secondary border-opacity-10">
                <div class="row g-4">
                    <!-- Deposit -->
                    <div class="col-md-6 border-end border-secondary border-opacity-10">
                        <h6 class="text-success mb-3"><i class="fas fa-arrow-down me-2"></i>Inbound Transfer</h6>

                        <div class="mb-3">
                            <label class="form-label">Simulation - Add Funds</label>
                            <div class="input-group">
                                <span class="input-group-text">SOL</span>
                                <input type="number" class="form-control font-mono" id="addAmount" placeholder="0.00"
                                    min="0" step="0.01">
                            </div>
                        </div>



                        <button class="btn btn-success w-100" onclick="connectWalletAndDeposit()">
                            <i class="fas fa-plus-circle me-2"></i>Execute Deposit
                        </button>
                    </div>

                    <!-- Withdraw -->
                    <div class="col-md-6">
                        <h6 class="text-danger mb-3"><i class="fas fa-arrow-up me-2"></i>Outbound Transfer</h6>

                        <div class="mb-3">
                            <label class="form-label">Destination Address</label>
                            <input type="text" class="form-control font-mono" id="withdrawAddress"
                                placeholder="Solana Wallet Address">
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-8">
                                <label class="form-label">Asset</label>
                                <select class="form-select font-mono" id="withdrawTokenSelect">
                                    <option value="" disabled selected>Select Token...</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control font-mono" id="withdrawAmount"
                                    placeholder="0.00">
                            </div>
                        </div>

                        <button class="btn btn-danger w-100" onclick="withdrawFunds()">
                            <i class="fas fa-paper-plane me-2"></i>Execute Withdrawal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Trading Engine Grid -->
    <div class="row g-4 mb-4">
        <!-- Configuration Config -->
        <div class="col-lg-4">
            <div class="glass-panel h-100">
                <div class="glass-header">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fa-solid fa-sliders text-accent"></i>
                        <h5 class="font-mono tracking-tight">STRATEGY CONFIG</h5>
                    </div>
                </div>
                <div class="glass-body">
                    <div class="mb-3">
                        <label class="form-label">Environment</label>
                        <select class="form-select font-mono" id="networkSelect">
                            <option value="mainnet">Mainnet (Live)</option>
                            <option value="devnet">Devnet (Simulation)</option>
                            <option value="testnet">Testnet (Beta)</option>
                        </select>
                    </div>

                    <!-- Hidden Execution Mode (Locked to Automatic) -->
                    <input type="hidden" id="tradingModeSelect" value="automatic">

                    <div class="mb-3">
                        <label class="form-label">Target Asset</label>
                        <select class="form-select font-mono mb-2" id="selectedToken">
                            <option value="So11111111111111111111111111111111111111112">SOL - Native Solana</option>
                            <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC - USD Coin</option>
                            <option value="4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R">RAY - Raydium</option>
                            <option value="JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN">JUP - Jupiter</option>
                        </select>
                        <input type="text" class="form-control font-mono text-xs" id="customTokenAddress"
                            placeholder="Or paste Custom Mint Address">
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Parameters -->
        <div class="col-lg-4">
            <div class="glass-panel h-100">
                <div class="glass-header">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fa-solid fa-microchip text-warning"></i>
                        <h5 class="font-mono tracking-tight">EXECUTION PARAMS</h5>
                    </div>
                </div>
                <div class="glass-body">
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label text-success">Take Profit (%)</label>
                            <input type="number" class="form-control font-mono" id="upPercentage" value="5" min="0"
                                step="0.1">
                        </div>
                        <div class="col-6">
                            <label class="form-label text-danger">Stop Loss / Buy (%)</label>
                            <input type="number" class="form-control font-mono" id="downPercentage" value="3" min="0"
                                step="0.1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Trade Volume (USD)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control font-mono fw-bold" id="tradeAmount" value="10"
                                min="0" step="0.01">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Order Splitting (Parts)</label>
                        <input type="number" class="form-control font-mono" id="partsInput" value="1" min="1" step="1">
                        <div class="form-text mt-1">Split volume into smaller orders to reduce impact.</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button id="startTradingBtn" class="btn btn-success py-3">
                            <i class="fa-solid fa-play me-2"></i>INITIATE SEQUENCE
                        </button>
                        <button id="stopTradingBtn" class="btn btn-danger py-3">
                            <i class="fa-solid fa-stop me-2"></i>TERMINATE SEQUENCE
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Monitor -->
        <div class="col-lg-4">
            <div class="glass-panel h-100">
                <div class="glass-header">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fa-solid fa-satellite-dish text-info"></i>
                        <h5 class="font-mono tracking-tight">LIVE MONITOR</h5>
                    </div>

                </div>
                <div class="glass-body">
                    <div class="d-flex align-items-center justify-content-between mb-4 p-3 rounded"
                        style="background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);">
                        <div>
                            <div class="text-muted small text-uppercase">Engine Status</div>
                            <div class="d-flex align-items-center mt-1">
                                <span class="status-indicator status-inactive" id="statusIndicator"></span>
                                <span class="font-mono fw-bold" id="statusText">STANDBY</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="text-muted small text-uppercase">Current Price</div>
                            <div class="price-display text-primary" id="currentPrice">$0.00</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <div class="p-2 rounded bg-opacity-10 bg-white">
                                <label class="small text-muted d-block">Base Price</label>
                                <span class="font-mono fw-bold" id="autoBasePrice">--</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded bg-opacity-10 bg-white">
                                <label class="small text-muted d-block">Dynamic Base</label>
                                <span class="font-mono fw-warning" id="dynamicBasePrice">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-3 rounded text-center mb-3"
                        style="background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);">
                        <label class="text-muted small text-uppercase mb-1">Cumulative P&L</label>
                        <div class="display-6 font-mono fw-bold" id="totalProfit">$0.00</div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small">Last Action</span>
                        <span class="badge bg-secondary font-mono" id="lastAction">NONE</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="glass-panel">
        <div class="glass-header">
            <div class="d-flex align-items-center gap-2">
                <i class="fa-solid fa-list-ul text-white"></i>
                <h5 class="font-mono tracking-tight">ORDER LOG</h5>
            </div>
        </div>
        <div class="glass-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Part</th>
                            <th>Asset</th>
                            <th>Exec Price</th>
                            <th>Base Price</th>
                            <th>P&L</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactionHistory">
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted font-mono">
                                NO TRANSACTIONS RECORDED
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Clock update for command center
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString();
    }, 1000);
</script>

<!-- Existing Scripts (Preserved for Logic) -->
<script>
    // DOM Elements - Mapping to ID preserved elements
    const startTradingBtn = document.getElementById('startTradingBtn');
    const stopTradingBtn = document.getElementById('stopTradingBtn');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const currentPrice = document.getElementById('currentPrice');
    const dynamicBasePrice = document.getElementById('dynamicBasePrice');
    const totalProfit = document.getElementById('totalProfit');
    const lastAction = document.getElementById('lastAction');
    const lastUpdated = document.getElementById('lastUpdated');
    const transactionHistory = document.getElementById('transactionHistory');
    const partsInput = document.getElementById('partsInput');
    let tradingInterval = null;
    let fullWalletAddress = '';

    // Start trading button event
    startTradingBtn.addEventListener('click', async function () {
        // Determine which token address to use
        let selectedToken = document.getElementById('selectedToken').value;
        const customTokenAddress = document.getElementById('customTokenAddress').value.trim();

        if (customTokenAddress) {
            // Validate that it looks like a Solana address (32-44 characters)
            if (customTokenAddress.length >= 32 && customTokenAddress.length <= 44) {
                selectedToken = customTokenAddress;
            } else {
                showToast('Please enter a valid Solana token address', 'danger');
                return;
            }
        }

        const config = {
            upPercentage: parseFloat(document.getElementById('upPercentage').value),
            downPercentage: parseFloat(document.getElementById('downPercentage').value),
            selectedToken: selectedToken,
            tradeAmount: parseFloat(document.getElementById('tradeAmount').value),
            parts: parseInt(document.getElementById('partsInput').value),
            network: document.getElementById('networkSelect').value,
            tradingMode: document.getElementById('tradingModeSelect').value
        };

        // Validate inputs
        if (isNaN(config.upPercentage) || isNaN(config.downPercentage) || isNaN(config.tradeAmount) || isNaN(config.parts)) {
            showToast('Please enter valid numbers for all fields', 'warning');
            return;
        }

        if (!config.selectedToken) {
            showToast('Please select a target asset', 'warning');
            return;
        }

        if (config.parts <= 0) {
            showToast('Number of parts must be > 0', 'warning');
            return;
        }

        try {
            startTradingBtn.disabled = true;
            startTradingBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>INITIATING...';

            const response = await fetch('/api/start-trading', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();
            console.log('Trading started:', data);

            if (response.ok) {
                updateStatus(true);
                showToast('Trading Sequence Initiated', 'success');

                // Update the automatic base price display
                setTimeout(async () => {
                    const statusResponse = await fetch('/api/trading-status');
                    const statusData = await statusResponse.json();
                    if (statusData.current_price) {
                        document.getElementById('autoBasePrice').textContent = statusData.current_price.toFixed(8);
                    }
                }, 1000);

                // Start polling
                if (tradingInterval) clearInterval(tradingInterval);
                tradingInterval = setInterval(updateTradingStatus, 2000);
            } else {
                throw new Error(data.message || 'Failed to start trading');
            }
        } catch (error) {
            console.error('Error starting trading:', error);
            showToast('Failed to start trading sequence', 'danger');
            startTradingBtn.disabled = false;
            startTradingBtn.innerHTML = '<i class="fa-solid fa-play me-2"></i>INITIATE SEQUENCE';
        }
    });

    // Stop trading button event
    stopTradingBtn.addEventListener('click', async function () {
        try {
            stopTradingBtn.disabled = true;
            stopTradingBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>TERMINATING...';

            const response = await fetch('/api/stop-trading', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();
            console.log('Trading stopped:', data);
            updateStatus(false);
            showToast('Trading Sequence Terminated', 'info');

            if (tradingInterval) {
                clearInterval(tradingInterval);
                tradingInterval = null;
            }
        } catch (error) {
            console.error('Error stopping trading:', error);
            showToast('Error stepping trading', 'danger');
        } finally {
            stopTradingBtn.disabled = false;
            stopTradingBtn.innerHTML = '<i class="fa-solid fa-stop me-2"></i>TERMINATE SEQUENCE';
        }
    });

    // Function to update trading status
    async function updateTradingStatus() {
        try {
            const response = await fetch('/api/trading-status');
            const data = await response.json();

            // Update current price
            if (data.current_price) {
                const priceValue = data.current_price;
                const displayPrice = priceValue < 0.01 ? priceValue.toFixed(8) : priceValue.toFixed(4);
                currentPrice.textContent = '$' + displayPrice;
                // lastUpdated removed
            }

            // Update dynamic base price
            if (data.dynamic_base_price !== undefined) {
                const baseValue = data.dynamic_base_price;
                const displayBase = baseValue < 0.01 ? baseValue.toFixed(8) : baseValue.toFixed(4);
                dynamicBasePrice.textContent = '$' + displayBase;
            }

            // Update total profit
            if (data.total_profit !== undefined) {
                const profitValue = data.total_profit;
                const displayProfit = Math.abs(profitValue).toFixed(4);

                if (profitValue > 0) {
                    totalProfit.textContent = '+$' + displayProfit;
                    totalProfit.className = 'display-6 font-mono fw-bold text-success';
                } else if (profitValue < 0) {
                    totalProfit.textContent = '-$' + displayProfit;
                    totalProfit.className = 'display-6 font-mono fw-bold text-danger';
                } else {
                    totalProfit.textContent = '$' + displayProfit;
                    totalProfit.className = 'display-6 font-mono fw-bold text-muted';
                }
            }

            // Update last action
            if (data.last_action) {
                lastAction.textContent = data.last_action.toUpperCase();
                // Color code the badge
                if (data.last_action.includes('buy')) lastAction.className = 'badge bg-success font-mono';
                else if (data.last_action.includes('sell')) lastAction.className = 'badge bg-danger font-mono';
                else lastAction.className = 'badge bg-secondary font-mono';
            }

            // Update transaction history
            if (data.transaction_history) {
                updateTransactionHistory(data.transaction_history);
            }
        } catch (error) {
            console.error('Error fetching trading status:', error);
        }
    }

    // Function to update UI status indicators
    function updateStatus(isRunning) {
        if (isRunning) {
            statusIndicator.className = 'status-indicator status-active';
            statusText.textContent = 'ACTIVE';
            statusText.className = 'font-mono fw-bold text-success';
            
            // Disable Start Button & Enable Stop Button
            startTradingBtn.disabled = true;
            startTradingBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>SEQUENCE RUNNING';
            stopTradingBtn.disabled = false;
        } else {
            statusIndicator.className = 'status-indicator status-inactive';
            statusText.textContent = 'STANDBY';
            statusText.className = 'font-mono fw-bold text-muted';
            
            // Enable Start Button
            startTradingBtn.disabled = false;
            startTradingBtn.innerHTML = '<i class="fa-solid fa-play me-2"></i>INITIATE SEQUENCE';
        }
    }

    // Function to display token balances
    function displayTokenBalances(balances) {
        // Show/hide loading indicator
        document.getElementById('tokenBalancesLoading').style.display = 'none';
        document.getElementById('tokenBalances').style.display = 'block';

        const tokenBalancesList = document.getElementById('tokenBalancesList');
        const noTokens = document.getElementById('noTokens');
        const withdrawSelect = document.getElementById('withdrawTokenSelect');

        // Save currently selected value to restore if possible
        const currentSelection = withdrawSelect.value;
        const withdrawSelectHTML = '<option value="" disabled selected>Select Token...</option>';
        withdrawSelect.innerHTML = withdrawSelectHTML;

        if (balances.length === 0) {
            noTokens.style.display = 'block';
            tokenBalancesList.innerHTML = '';
            return;
        }

        noTokens.style.display = 'none';
        tokenBalancesList.innerHTML = '';

        balances.forEach(balance => {
            // Add to table
            const row = document.createElement('tr');
            // Simplified display for better UI
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="token-icon">${balance.token.substring(0, 2)}</div>
                        <div>
                            <div class="fw-bold">${balance.token}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">${balance.name || 'Unknown Asset'}</small>
                        </div>
                    </div>
                </td>
                <td class="text-end font-mono">${balance.balance ? balance.balance.toFixed(6) : '0.000000'}</td>
            `;
            tokenBalancesList.appendChild(row);

            // Add to withdraw dropdown
            if (balance.balance > 0) {
                const option = document.createElement('option');
                option.value = balance.mint;
                option.text = `${balance.token} (${balance.balance.toFixed(4)})`;
                option.dataset.decimals = balance.decimals;
                withdrawSelect.appendChild(option);
            }
        });

        // Restore selection if it still exists
        if (currentSelection) {
            for (let i = 0; i < withdrawSelect.options.length; i++) {
                if (withdrawSelect.options[i].value === currentSelection) {
                    withdrawSelect.value = currentSelection;
                    break;
                }
            }
        }
    }

    // Function to fetch wallet info
    async function fetchWalletInfo() {
        try {
            const response = await fetch('/api/wallet-info');
            const data = await response.json();

            if (data.success) {
                fullWalletAddress = data.wallet_address;
                // Update both dashboard and modal
                const el = document.getElementById('walletAddress');
                if (el) el.textContent = data.wallet_address;
                const modalEl = document.getElementById('modalWalletAddress');
                if (modalEl) modalEl.value = data.wallet_address;
                document.getElementById('walletError').style.display = 'none';
            } else {
                document.getElementById('walletAddress').textContent = 'Error loading wallet';
                document.getElementById('walletError').textContent = data.message;
                document.getElementById('walletError').style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching wallet info:', error);
            document.getElementById('walletAddress').textContent = 'Connection Failed';
            document.getElementById('walletError').textContent = 'API Connection Failed';
            document.getElementById('walletError').style.display = 'block';
        }
    }

    // Function to fetch token balances
    async function fetchTokenBalances() {
        try {
            // Show loading state
            document.getElementById('tokenBalancesLoading').style.display = 'block';
            document.getElementById('tokenBalances').style.display = 'none';
            document.getElementById('noTokens').style.display = 'none';

            const response = await fetch('/api/wallet-balance');
            const data = await response.json();

            if (data.success) {
                displayTokenBalances(data.balances);

                // Also update modal table using the same data
                const modalTbody = document.getElementById('modalTokenBalances');
                if (modalTbody) {
                    modalTbody.innerHTML = '';
                    data.balances.forEach(balance => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${balance.token}</td>
                            <td>${balance.name || '-'}</td>
                            <td class="text-end font-mono">${balance.balance.toFixed(6)}</td>
                         `;
                        modalTbody.appendChild(row);
                    });
                }
            } else {
                console.error('Error from backend:', data.message);
                document.getElementById('tokenBalancesLoading').style.display = 'none';
                document.getElementById('walletError').textContent = data.message || 'Error loading balances';
                document.getElementById('walletError').style.display = 'block';
            }
        } catch (error) {
            console.error('Error fetching token balances:', error);
            document.getElementById('tokenBalancesLoading').style.display = 'none';
            document.getElementById('tokenBalances').innerHTML = '<div class="alert alert-danger p-2 small">Sync Failed</div>';
        }
    }

    // Function to refresh wallet data
    async function refreshWalletData() {
        // Add rotation animation to buttons
        const icons = document.querySelectorAll('.fa-sync-alt');
        icons.forEach(i => i.classList.add('fa-spin'));

        await fetchWalletInfo();
        await fetchTokenBalances();

        setTimeout(() => {
            icons.forEach(i => i.classList.remove('fa-spin'));
            showToast('Chain data synchronized', 'success');
        }, 500);
    }

    // Function to copy wallet address to clipboard
    function copyWalletAddress() {
        if (fullWalletAddress) {
            navigator.clipboard.writeText(fullWalletAddress).then(() => {
                showToast('Address Copied', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy address', 'danger');
            });
        }
    }

    // Function to add funds to wallet
    async function addFunds() {
        const amount = document.getElementById('addAmount').value;

        if (!amount || parseFloat(amount) <= 0) {
            showToast('Please enter a valid amount', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/add-funds', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ amount: parseFloat(amount) })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Funds deposited successfully', 'success');
                refreshWalletData();
                document.getElementById('addAmount').value = '';
            } else {
                showToast('Deposit failed: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error adding funds:', error);
            showToast('Deposit failed', 'danger');
        }
    }

    // Function to withdraw funds from wallet
    async function withdrawFunds() {
        const address = document.getElementById('withdrawAddress').value;
        const amount = document.getElementById('withdrawAmount').value;
        const tokenSelect = document.getElementById('withdrawTokenSelect');
        const selectedOption = tokenSelect.options[tokenSelect.selectedIndex];

        if (!address) {
            showToast('Enter destination address', 'warning');
            return;
        }

        if (!amount || parseFloat(amount) <= 0) {
            showToast('Enter valid amount', 'warning');
            return;
        }

        if (!selectedOption || !selectedOption.value) {
            showToast('Select asset to withdraw', 'warning');
            return;
        }

        const tokenMint = selectedOption.value;
        const decimals = parseInt(selectedOption.dataset.decimals || 9);

        // UI Feedback
        const btn = document.querySelector('button[onclick="withdrawFunds()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing';

        try {
            const response = await fetch('/api/withdraw-funds', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    destination_address: address,
                    amount: parseFloat(amount),
                    token_mint: tokenMint,
                    decimals: decimals
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Withdrawal Successful', 'success');
                refreshWalletData();
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('withdrawAddress').value = '';
            } else {
                showToast('Withdrawal Failed: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error withdrawing funds:', error);
            showToast('Network error during withdrawal', 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Connect wallet alias for addFunds
    const connectWalletAndDeposit = addFunds;

    // Function to update transaction history table
    function updateTransactionHistory(transactions) {
        if (transactions.length === 0) {
            transactionHistory.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">NO TRANSACTIONS RECORDED</td></tr>';
            return;
        }

        let html = '';
        transactions.slice().reverse().forEach(tx => {
            const displayToken = tx.token_symbol || tx.token.substring(0, 6) + '...';
            const displayPrice = parseFloat(tx.price.toFixed(8)).toString();
            const displayBasePrice = tx.base_price_at_execution ? parseFloat(tx.base_price_at_execution.toFixed(8)).toString() : '--';

            let displayPL = '--';
            let plClass = 'text-muted';

            if (tx.base_price_at_execution && tx.action === 'sell') {
                const profitLoss = tx.price - tx.base_price_at_execution;
                const formattedPL = parseFloat(profitLoss.toFixed(8)).toString();
                if (profitLoss >= 0) {
                    displayPL = '+' + formattedPL;
                    plClass = 'text-success fw-bold';
                } else {
                    displayPL = formattedPL;
                    plClass = 'text-danger fw-bold';
                }
            }

            let displayPart = tx.action === 'buy' ? '-' : 'N/A';
            if (tx.part_number !== undefined && tx.part_number !== null) {
                displayPart = (tx.total_parts && tx.total_parts > 1) ?
                    `<span class="badge bg-dark border border-secondary">${tx.part_number}/${tx.total_parts}</span>` :
                    tx.part_number;
            }

            const actionBadge = tx.action === 'buy' ? 'bg-success' : 'bg-danger';

            html += `<tr>
                <td class="font-mono small text-muted">${tx.timestamp.split(' ')[1] || tx.timestamp}</td>
                <td><span class="badge ${actionBadge}">${tx.action.toUpperCase()}</span></td>
                <td>${displayPart}</td>
                <td class="fw-bold">${displayToken}</td>
                <td class="font-mono">$${displayPrice}</td>
                <td class="font-mono text-muted">$${displayBasePrice}</td>
                <td class="font-mono ${plClass}">${displayPL}</td>
                <td><i class="fas fa-check-circle text-success" title="Completed"></i></td>
            </tr>`;
        });
        transactionHistory.innerHTML = html;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        refreshWalletData();
    });
</script>
{% endblock %}