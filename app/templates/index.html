<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Trading Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        #transactionHistory {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="text-center mb-4">Solana Trading Bot</h1>
                <p class="text-center text-muted mb-5">Automated trading based on your price thresholds</p>
            </div>
        </div>

        <div class="row">
            <!-- Trading Configuration -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Trading Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="networkSelect" class="form-label">Network</label>
                            <select class="form-select" id="networkSelect">
                                <option value="mainnet">Mainnet</option>
                                <option value="devnet">Devnet</option>
                                <option value="testnet">Testnet</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="tradingModeSelect" class="form-label">Trading Mode</label>
                            <select class="form-select" id="tradingModeSelect">
                                <option value="automatic">Automatic</option>
                                <option value="user">User Approval</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="selectedToken" class="form-label">Select Token (or enter custom below)</label>
                            <select class="form-select" id="selectedToken">
                                {% for token in tokens %}
                                <option value="{{ token.mint }}">{{ token.symbol }} - {{ token.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="customTokenAddress" class="form-label">Or Enter Custom Token Address</label>
                            <input type="text" class="form-control" id="customTokenAddress" placeholder="Enter token mint address (e.g., So11111111111111111111111111111111111111112 for wSOL/SOL)">
                            <div class="form-text">Leave empty to use selected token above</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Token Balances</label>
                            <div id="tokenBalances">
                                <div class="alert alert-info">Loading balances...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Parameters -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Trading Parameters</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Base Price ($)</label>
                            <div class="form-control-plaintext bg-light p-2 rounded">$<span id="autoBasePrice">--</span></div>
                            <div class="form-text">Automatically set to current market price when trading starts</div>
                        </div>

                        <div class="mb-3">
                            <label for="upPercentage" class="form-label">Sell High Percentage (%)</label>
                            <input type="number" class="form-control" id="upPercentage" placeholder="Enter up percentage" value="5" min="0" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="downPercentage" class="form-label">Buy Low Percentage (%)</label>
                            <input type="number" class="form-control" id="downPercentage" placeholder="Enter down percentage" value="3" min="0" step="0.1">
                        </div>

                        <div class="mb-3">
                            <label for="tradeAmount" class="form-label">Trade Amount</label>
                            <input type="number" class="form-control" id="tradeAmount" placeholder="Enter trade amount" value="10" min="0" step="0.01">
                        </div>

                        <div class="mb-3">
                            <label for="partsInput" class="form-label">Number of Parts</label>
                            <input type="number" class="form-control" id="partsInput" placeholder="Enter number of parts" value="1" min="1" step="1">
                            <div class="form-text">Total trade amount will be divided into this many parts</div>
                        </div>

                        <div class="d-grid gap-2">
                            <button id="startTradingBtn" class="btn btn-success">Start Trading</button>
                            <button id="stopTradingBtn" class="btn btn-danger">Stop Trading</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Status and Current Price -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Trading Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div>
                                <span class="status-indicator status-inactive" id="statusIndicator"></span>
                                <span id="statusText">Stopped</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Current Price ($)</label>
                            <div class="alert alert-info" id="currentPrice">$0.00</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dynamic Base Price ($)</label>
                            <div class="alert alert-warning" id="dynamicBasePrice">$0.00</div>
                            <div class="form-text">Updated after each buy/sell operation</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Total Profit ($)</label>
                            <div class="alert alert-success" id="totalProfit">$0.00</div>
                            <div class="form-text">Cumulative profit/loss from all trades</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Last Action</label>
                            <div class="alert alert-light" id="lastAction">None</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Last Updated</label>
                            <div class="alert alert-light" id="lastUpdated">Never</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Transaction History</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Action</th>
                                        <th>Part</th>
                                        <th>Token</th>
                                        <th>Price ($)</th>
                                        <th>Base Price ($)</th>
                                        <th>P&L ($)</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionHistory">
                                    <tr>
                                        <td colspan="8" class="text-center">No transactions yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
        const startTradingBtn = document.getElementById('startTradingBtn');
        const stopTradingBtn = document.getElementById('stopTradingBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const currentPrice = document.getElementById('currentPrice');
        const dynamicBasePrice = document.getElementById('dynamicBasePrice');
        const totalProfit = document.getElementById('totalProfit');
        const lastAction = document.getElementById('lastAction');
        const lastUpdated = document.getElementById('lastUpdated');
        const transactionHistory = document.getElementById('transactionHistory');
        const partsInput = document.getElementById('partsInput');
        let tradingInterval = null;

        // Start trading button event
        startTradingBtn.addEventListener('click', async function() {
            // Determine which token address to use
            let selectedToken = document.getElementById('selectedToken').value;
            const customTokenAddress = document.getElementById('customTokenAddress').value.trim();

            if (customTokenAddress) {
                // Validate that it looks like a Solana address (32-44 characters)
                if (customTokenAddress.length >= 32 && customTokenAddress.length <= 44) {
                    selectedToken = customTokenAddress;
                } else {
                    alert('Please enter a valid Solana token address (32-44 characters)');
                    return;
                }
            }

            const config = {
                upPercentage: parseFloat(document.getElementById('upPercentage').value),
                downPercentage: parseFloat(document.getElementById('downPercentage').value),
                selectedToken: selectedToken,
                tradeAmount: parseFloat(document.getElementById('tradeAmount').value),
                parts: parseInt(document.getElementById('partsInput').value),
                network: document.getElementById('networkSelect').value,
                tradingMode: document.getElementById('tradingModeSelect').value
            };

            // Validate inputs
            if (isNaN(config.upPercentage) || isNaN(config.downPercentage) || isNaN(config.tradeAmount) || isNaN(config.parts)) {
                alert('Please enter valid numbers for all fields');
                return;
            }

            if (!config.selectedToken) {
                alert('Please select a token or enter a custom token address');
                return;
            }

            if (config.parts <= 0) {
                alert('Number of parts must be greater than 0');
                return;
            }

            try {
                const response = await fetch('/api/start-trading', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                console.log('Trading started:', data);

                // Update the automatic base price display to show the current market price
                // Get current price from the status API to show as the base price
                setTimeout(async () => {
                    const statusResponse = await fetch('/api/trading-status');
                    const statusData = await statusResponse.json();
                    if (statusData.current_price) {
                        document.getElementById('autoBasePrice').textContent = statusData.current_price.toFixed(8);
                    }
                }, 1000);  // Slight delay to allow base price to be set

                updateStatus(true);

                // Start polling for status updates
                if (tradingInterval) clearInterval(tradingInterval);
                tradingInterval = setInterval(updateTradingStatus, 2000);
            } catch (error) {
                console.error('Error starting trading:', error);
                alert('Error starting trading');
            }
        });

        // Stop trading button event
        stopTradingBtn.addEventListener('click', async function() {
            try {
                const response = await fetch('/api/stop-trading', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('Trading stopped:', data);
                updateStatus(false);

                if (tradingInterval) {
                    clearInterval(tradingInterval);
                    tradingInterval = null;
                }
            } catch (error) {
                console.error('Error stopping trading:', error);
                alert('Error stopping trading');
            }
        });

        // Function to update trading status
        async function updateTradingStatus() {
            try {
                const response = await fetch('/api/trading-status');
                const data = await response.json();

                // Update current price
                if (data.current_price) {
                    // Display with full precision for tokens with very low values
                    const priceValue = data.current_price;
                    let displayPrice;
                    if (priceValue >= 0.01) {
                        displayPrice = priceValue.toFixed(8);  // 8 decimal places for precision
                    } else {
                        displayPrice = priceValue.toFixed(8);  // 8 decimal places for low-value tokens
                    }
                    // Remove trailing zeros but keep precision
                    displayPrice = parseFloat(displayPrice).toString();
                    currentPrice.textContent = '$' + displayPrice;
                    lastUpdated.textContent = new Date().toLocaleTimeString();
                }

                // Update dynamic base price
                if (data.dynamic_base_price !== undefined) {
                    const dynamicBasePriceValue = data.dynamic_base_price;
                    let displayDynamicPrice;
                    if (dynamicBasePriceValue >= 0.01) {
                        displayDynamicPrice = dynamicBasePriceValue.toFixed(8);  // 8 decimal places for precision
                    } else {
                        displayDynamicPrice = dynamicBasePriceValue.toFixed(8);  // 8 decimal places for low-value tokens
                    }
                    // Remove trailing zeros but keep precision
                    displayDynamicPrice = parseFloat(displayDynamicPrice).toString();
                    dynamicBasePrice.textContent = '$' + displayDynamicPrice;
                }

                // Update total profit
                if (data.total_profit !== undefined) {
                    const profitValue = data.total_profit;
                    let displayProfit;
                    if (Math.abs(profitValue) >= 0.01) {
                        displayProfit = profitValue.toFixed(8);  // 8 decimal places for precision
                    } else {
                        displayProfit = profitValue.toFixed(8);  // 8 decimal places for low-value profits
                    }
                    // Remove trailing zeros but keep precision
                    displayProfit = parseFloat(displayProfit).toString();
                    // Add color coding based on profit/loss
                    if (profitValue > 0) {
                        totalProfit.textContent = '+$' + displayProfit;
                        totalProfit.className = 'alert alert-success';  // Green for profit
                    } else if (profitValue < 0) {
                        totalProfit.textContent = '-$' + Math.abs(parseFloat(displayProfit)).toString();
                        totalProfit.className = 'alert alert-danger';  // Red for loss
                    } else {
                        totalProfit.textContent = '$' + displayProfit;
                        totalProfit.className = 'alert alert-secondary';  // Gray for neutral
                    }
                }

                // Update last action
                if (data.last_action) {
                    lastAction.textContent = data.last_action.charAt(0).toUpperCase() + data.last_action.slice(1);
                }

                // Update transaction history
                if (data.transaction_history) {
                    updateTransactionHistory(data.transaction_history);
                }
            } catch (error) {
                console.error('Error fetching trading status:', error);
            }
        }

        // Function to update UI status indicators
        function updateStatus(isRunning) {
            if (isRunning) {
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = 'Running';
            } else {
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'Stopped';
            }
        }

        // Function to display token balances
        function displayTokenBalances(balances) {
            if (balances.length === 0) {
                tokenBalances.innerHTML = '<div class="alert alert-info">No tokens found in wallet</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Token</th><th>Balance</th><th>Mint Address</th></tr></thead><tbody>';
            balances.forEach(balance => {
                html += `<tr>
                    <td>
                        <div>${balance.token}</div>
                        <small class="text-muted">${balance.name || ''}</small>
                    </td>
                    <td class="text-end">${balance.balance ? balance.balance.toFixed(6) : '0.000000'}</td>
                    <td><small>${balance.mint ? balance.mint.substring(0, 8) + '...' : ''}</small></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            tokenBalances.innerHTML = html;
        }

        // Function to update transaction history table
        function updateTransactionHistory(transactions) {
            if (transactions.length === 0) {
                transactionHistory.innerHTML = '<tr><td colspan="8" class="text-center">No transactions yet</td></tr>';
                return;
            }

            let html = '';
            transactions.slice().reverse().forEach(tx => {
                // Use token symbol if available, otherwise use first 6 chars of token mint
                const displayToken = tx.token_symbol || tx.token.substring(0, 6) + '...';
                // Display price with full precision
                const displayPrice = parseFloat(tx.price.toFixed(8)).toString();
                const displayBasePrice = tx.base_price_at_execution ? parseFloat(tx.base_price_at_execution.toFixed(8)).toString() : 'N/A';
                // Calculate P&L if base price is available
                let displayPL = 'N/A';
                let plClass = '';
                if (tx.base_price_at_execution && tx.action === 'sell') {
                    const profitLoss = tx.price - tx.base_price_at_execution;
                    const formattedPL = parseFloat(profitLoss.toFixed(8)).toString();
                    if (profitLoss >= 0) {
                        displayPL = '+' + formattedPL;
                        plClass = 'text-success';  // Positive P&L in green
                    } else {
                        displayPL = formattedPL;
                        plClass = 'text-danger';  // Negative P&L in red
                    }
                } else if (tx.action === 'buy') {
                    displayPL = 'N/A';  // No P&L for buy transactions
                }

                // Part information - only show for sell operations
                let displayPart = tx.action === 'buy' ? '-' : 'N/A';
                if (tx.part_number !== undefined && tx.part_number !== null) {
                    if (tx.total_parts && tx.total_parts > 1) {
                        displayPart = `${tx.part_number}/${tx.total_parts}`;
                    } else {
                        displayPart = tx.part_number;  // Just show the part number if total is not informative
                    }
                } else if (tx.action === 'buy') {
                    displayPart = '-';  // Show dash for buy operations since they don't consume parts
                }

                // Transaction status badge
                const statusBadge = tx.status === 'completed' ? 'success' : 'danger';
                const statusText = tx.status === 'completed' ? 'Completed' : 'Failed';

                html += `<tr>
                    <td>${tx.timestamp}</td>
                    <td><span class="badge bg-${tx.action === 'buy' ? 'success' : 'danger'}">${tx.action}</span></td>
                    <td>${displayPart}</td>  <!-- Part number -->
                    <td>${displayToken}</td>
                    <td>$${displayPrice}</td>  <!-- Current price at execution -->
                    <td>$${displayBasePrice}</td>  <!-- Base price at execution -->
                    <td class="${plClass}">$${displayPL}</td>  <!-- Profit/Loss -->
                    <td>${tx.amount}</td>
                    <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                </tr>`;
            });

            transactionHistory.innerHTML = html;
        }

        // Function to display token balances
        function displayTokenBalances(balances) {
            const tokenBalancesDiv = document.getElementById('tokenBalances');

            if (balances.length === 0) {
                tokenBalancesDiv.innerHTML = '<div class="alert alert-info">No SPL tokens found (SOL balance shown separately)</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Token</th><th>Balance</th><th>Mint Address</th></tr></thead><tbody>';
            balances.forEach(balance => {
                html += `<tr>
                    <td>
                        <div>${balance.token}</div>
                        <small class="text-muted">${balance.name || ''}</small>
                    </td>
                    <td class="text-end">${balance.balance ? balance.balance.toFixed(6) : '0.000000'}</td>
                    <td><small>${balance.mint ? balance.mint.substring(0, 8) + '...' : ''}</small></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            tokenBalancesDiv.innerHTML = html;
        }

        // Function to fetch token balances
        async function fetchTokenBalances() {
            try {
                const response = await fetch('/api/wallet-balance');
                const data = await response.json();

                if (data.success) {
                    displayTokenBalances(data.balances);
                } else {
                    console.error('Error from backend:', data.message);
                    displayTokenBalances(data.balances || []); // Use any balances returned even if success is false
                }
            } catch (error) {
                console.error('Error fetching token balances:', error);
                document.getElementById('tokenBalances').innerHTML = '<div class="alert alert-danger">Error loading balances</div>';
            }
        }

        // Initialize the page
        async function init() {
            updateStatus(false);
            // Fetch token balances on page load
            await fetchTokenBalances();

            // Refresh balances every 30 seconds
            setInterval(fetchTokenBalances, 30000);
        }

        // Call init when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>